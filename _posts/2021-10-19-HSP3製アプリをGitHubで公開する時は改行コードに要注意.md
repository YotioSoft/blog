---
layout: post
title: HSP3製アプリをGitHubで公開する時は改行コードに要注意
tags: [HSP3, GitHub]
excerpt_separator: <!--more-->
---

以前、HSP3(Hot Soup Processor)製のアプリをGitHubで公開しようとしたときにハマった話です。いつものようにコミットして``git push``したら、GitHubからダウンロードした配布物が何故かエラーを吐いて起動しない。  
 ![SnapCrab_Error_2021-10-19_3-56-52_No-00](../../../assets/img/post/2021-10-17-HSP3製アプリをGitHubで公開する時は改行コードに注意/SnapCrab_Error_2021-10-19_3-56-52_No-00.png)  
OneDriveでのファイル共有など、配布にGitHubを介されければ動く…  
なぜだ…なぜだー

<!--more-->

# 問題のブツ

今回GitHubで公開する際にハマったのは、[こちら](https://Github.com/YotioSoft/worldtimepiece3){:target="_blank"}で公開しているWorld Timepieceという世界時計アプリ。HSP3製で、世界各地の時差をテキストファイルに保存し、起動時に読み込むことで現地時間を計算して表示しています。  
![worldtimepiece](../../../assets/img/post/2021-10-17-HSP3製アプリをGitHubで公開する時は改行コードに注意/worldtimepiece.png)

# 原因は改行コード

調べてみると、Gitは既定でWindowsから``git commit``する際に全てのファイルの文字コードを``LF``に変換する仕様らしい。改行コードというのはファイルの改行を示すための文字コードですが、Windowsでは``CR+LF``が、MacやLinuxなどのUNIX系OSでは``LF``が標準で採用されています。つまり、GitはWindowsからcommit&pushするテキストファイルの改行コードをUNIXに合わせて自動変換しているということです。  
一方、HSP3で読み込むファイルは``CR+LF``が標準仕様。つまり、起動時に世界各地の時差を書き込んだテキストファイルを読み込む際に、``CR+LF``のつもりでファイルを読み込んだら``LF``に変換されていて上手く読み込めない、というのが原因と考えられます。  
![hsp3crlf_image](../../../assets/img/post/2021-10-17-HSP3製アプリをGitHubで公開する時は改行コードに注意/hsp3crlf_image.png)  

Windows版Gitでは、``git pull``するとテキストファイルを``CR+LF``に自動で戻してくれます。しかし、GitHub上でリリースしたものは通常GitHub上でそのままzip形式に圧縮され、通常はブラウザから直接ダウンロードされますから、当然ファイルの改行コードは``LF``のままダウンロードされます。 

まとめると、  

- Git for WindowsはUNIX系OSと互換性を持たせるため``git commit``時に``CR+LF``を``LF``に自動変換する
- Git for Windowsは``git pull``時に``LF``を``CR+LF``に自動変換する
- しかし、GitHubでリリースしたものは``LF``のまま公開される
  - ソフトウェアによっては読み込むファイルの改行コードの違いでエラーが発生（HSP3の場合も該当）  

…正直、Windowsでしか開発しないのに余計なお世話だ！ってなりません？（そもそもGitがLinux用に作られたという話はさておき）  
ここからは、Gitによる自動変換を無効化する方法を紹介します。



# 対処法：Gitに改行コードの自動変換をさせない

まずはコマンドラインツール（MINGW32やMSYS2など）を開き、対象となるローカルリポジトリへ移動（既にローカルリポジトリ上にいる場合は不要）。  

```bash
$ cd {ローカルリポジトリのファイルパス}
```


次に以下のコマンドを実行。  

```bash
$ git config core.autocrlf false
```

これだけでOKです。何をしているかというと、リポジトリ内での改行コードの自動変換を無効化しています。  
あとは普通に``git commit``して``git push``すれば、``CR+LF``のままGitHubにpushされます。これでGitHubでリリースしても大丈夫。  

なお、この設定は該当のリポジトリにだけ適用されます。全リポジトリに適用したい場合は``--global``オプションを付け加えますが要注意（理由は後述）。



# 注意すべき点

当然、これによって改行コードは自動変換されなくなりますから、特に複数のOS、複数の開発者間で開発している際は要注意です。``CR+LF``と``LF``のファイルが混在してしまうとビルドエラー等が多発し他の共同開発者に迷惑をかけてしまいます。  
よって、HSP3製アプリなどWindowsでしか開発・実行しないリポジトリにのみローカルで設定を適用することをおすすめします。

